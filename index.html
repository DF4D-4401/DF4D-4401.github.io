<!DOCTYPE html>  
<html lang="en">  

<head> 
    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "oc47rrtx4x");
</script>
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Post Fetcher</title>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>  
    <style>  
        body {  
            font-family: Arial, sans-serif;  
            background-color: #f2f2f2;  
            margin: 0;  
            padding: 20px;  
        }  

        h1 {  
            text-align: center;  
            color: #333;  
        }  

        form {  
            background-color: #fff;  
            padding: 20px;  
            border-radius: 5px;  
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);  
            max-width: 400px;  
            margin: 0 auto 20px;  
        }  

        label {  
            display: block;  
            margin: 10px 0 5px;  
        }  

        input[type="text"],  
        input[type="number"] {  
            width: 100%;  
            padding: 10px;  
            margin-bottom: 10px;  
            border: 1px solid #ccc;  
            border-radius: 4px;  
        }  

        button {  
            background-color: #28a745;  
            color: white;  
            padding: 10px 15px;  
            border: none;  
            border-radius: 4px;  
            cursor: pointer;  
            margin-right: 5px;  
        }  

        button:hover {  
            background-color: #218838;  
        }  

        pre {  
            background: white;  
            padding: 20px;  
            border-radius: 5px;  
            overflow: auto;  
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);  
        }  

        .pagination {  
            text-align: center;  
            margin: 15px 0;  
        }  

        .post {  
            background-color: #fff;  
            padding: 15px;  
            margin: 10px 0;  
            border-radius: 5px;  
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);  
        }  

        .download-buttons {  
            margin-top: 10px;  
        }  

        .image-button {  
            margin-right: 5px;  
        }  
    </style>  
</head>  

<body>  
    <h1>Post Fetcher</h1>  
    <form id="fetchForm">  
        <label for="userId">User ID:</label>  
        <input type="text" id="userId" required>  
        <label for="forumId">Forum ID:</label>  
        <input type="text" id="forumId" required>  
        <label for="pageSize">输入帖子数量:</label>  
        <input type="number" id="pageSize" value="10" min="1" required>  
        <button type="submit">Fetch Posts</button>  
    </form>  
    <pre id="output"></pre>  
    <div id="pagination" class="pagination"></div>  

    <script>  
        let postsData = [];  
        let currentPage = 1;  
        const postsPerPage = 30;  

        document.getElementById('fetchForm').addEventListener('submit', async function (event) {  
            event.preventDefault();  

            const userId = document.getElementById('userId').value;  
            const forumId = document.getElementById('forumId').value;  
            const pageSize = document.getElementById('pageSize').value;  
            const output = document.getElementById('output');  
            output.textContent = 'Loading...';  

            try {  
                const response = await fetch(`https://choa.fun/api/v0/user/list_posts?marker=&pageSize=${pageSize}&forumId=${forumId}&userId=${userId}`);  
                const data = await response.json();  

                if (data.success) {  
                    postsData = data.data.posts;  
                    output.innerHTML = `<strong>成功爬取 ${postsData.length} 个帖子</strong><br><br>`;  
                    renderPosts();  
                    renderPagination();  
                } else {  
                    output.textContent = '请求失败，请检查后重试！';  
                }  
            } catch (error) {  
                console.error(error);  
                output.textContent = '发生错误，请重试！';  
            }  
        });  

        function renderPosts() {  
            const output = document.getElementById('output');  
            output.innerHTML = ''; // 清空内容  
            const start = (currentPage - 1) * postsPerPage;  
            const end = Math.min(start + postsPerPage, postsData.length);  

            for (let i = start; i < end; i++) {  
                const post = postsData[i];  
                const postDiv = document.createElement('div');  
                postDiv.className = 'post';  
                postDiv.innerHTML = `  
                    <strong>${post.title}</strong> (ID: ${post.postId})<br>  
                    内容: ${post.content || '无内容'}<br>  
                    评论数: ${post.comments || 0}<br>  
                    <div class="download-buttons">  
                        <button onclick="downloadPost(${i})">下载此帖子</button>  
                        ${post.comments > 0 ? `<button onclick="downloadComments(${post.postId}, '${post.title}')">下载评论</button>` : ''}  
                        ${post.images ? post.images.map(image => `<button class="image-button" onclick="downloadImage('${'https://i.chao-fan.com/' + image}')">下载图片</button>`).join('') : ''}  
                    </div>  
                `;  
                output.appendChild(postDiv);  
            }  
            const downloadAllBtn = document.createElement('button');  
            downloadAllBtn.innerText = '下载整页为ZIP';  
            downloadAllBtn.onclick = downloadAll;  
            output.appendChild(downloadAllBtn);  
            output.appendChild(document.createElement('br'));  

            const prevBtn = document.createElement('button');  
            prevBtn.innerText = '上一页';  
            prevBtn.onclick = prevPage;  

            const nextBtn = document.createElement('button');  
            nextBtn.innerText = '下一页';  
            nextBtn.onclick = nextPage;  

            output.appendChild(prevBtn);  
            output.appendChild(nextBtn);  
        }  

        function renderPagination() {  
            const pagination = document.getElementById('pagination');  
            pagination.innerHTML = `当前页面: ${currentPage} / ${Math.ceil(postsData.length / postsPerPage)}`;  
        }  

        function prevPage() {  
            if (currentPage > 1) {  
                currentPage--;  
                renderPosts();  
                renderPagination();  
            }  
        }  

        function nextPage() {  
            if (currentPage * postsPerPage < postsData.length) {  
                currentPage++;  
                renderPosts();  
                renderPagination();  
            }  
        }  

        async function downloadPost(index) {  
            const post = postsData[index];  
            const blob = new Blob([JSON.stringify(post, null, 4)], { type: 'application/json' });  
            saveAs(blob, `post_${post.postId}.json`);  
        }  

        async function downloadComments(postId, postTitle) {  
            const response = await fetch(`https://choa.fun/api/v0/list_comments?postId=${postId}`);  
            const data = await response.json();  

            if (data.success) {  
                const commentsJson = JSON.stringify(data.data, null, 4);  
                const blob = new Blob([commentsJson], { type: 'application/json' });  
                saveAs(blob, `post_${postId}_comments.json`);  
            } else {  
                alert('评论下载失败');  
            }  
        }  

        async function downloadImage(imageUrl) {  
            const a = document.createElement('a');  
            a.href = imageUrl;  
            a.download = imageUrl.split('/').pop();  
            document.body.appendChild(a);  
            a.click();  
            document.body.removeChild(a);  
        }  

        async function downloadAll() {  
            const zip = new JSZip();  

            for (let i = 0; i < postsData.length; i++) {  
                const post = postsData[i];  
                const postFolder = zip.folder(`post_${post.postId}`); // 以帖子 ID 创建文件夹  
                const commentsFolder = postFolder.folder('comments'); // 为评论创建子文件夹  

                // 添加帖子正文  
                const postContent = JSON.stringify(post, null, 4);  
                postFolder.file(`post_${post.postId}.json`, postContent);  

                // 添加帖子中的图片  
                const images = post.images || [];  
                for (const image of images) {  
                    const imageUrl = 'https://i.chao-fan.com/' + image;  
                    const imgBlob = await fetch(imageUrl).then(res => res.blob());  
                    postFolder.file(image, imgBlob);  
                }  

                // 获取评论并添加到子文件夹  
                const commentsResponse = await fetch(`https://choa.fun/api/v0/list_comments?postId=${post.postId}`);  
                const commentsData = await commentsResponse.json();  

                if (commentsData.success) {  
                    const commentsJson = JSON.stringify(commentsData.data, null, 4);  
                    commentsFolder.file(`post_${post.postId}_comments.json`, commentsJson);  

                    // 添加评论中的图片到子文件夹  
                    for (const comment of commentsData.data) {  
                        if (comment.imageNames) {  
                            const imgList = comment.imageNames.split(',');  
                            for (const img of imgList) {  
                                const commentImageUrl = 'https://i.chao-fan.com/' + img;  
                                const commentImgBlob = await fetch(commentImageUrl).then(res => res.blob());  
                                commentsFolder.file(img, commentImgBlob);  
                            }  
                        }  
                    }  
                }  
            }  

            zip.generateAsync({ type: "blob" }).then(content => {  
                saveAs(content, "posts_and_comments.zip");  
            });  
        }  
    </script>  
</body>  

</html>
