<!DOCTYPE html>  
<html lang="en">  
<head>  
 <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "o4k68jfqvq");
</script>
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Post Fetcher</title>  
</head>  
<body>  
    <h1>Post Fetcher</h1>  
    <form id="fetchForm">  
        <label for="userId">User ID:</label>  
        <input type="text" id="userId" required>  
        <br>  
        <label for="forumId">Forum ID:</label>  
        <input type="text" id="forumId" required>  
        <br>  
        <label for="pageSize">每页帖子数量:</label>  
        <input type="number" id="pageSize" value="30" min="1" required>  
        <br>  
        <button type="submit">Fetch Posts</button>  
    </form>  
    <pre id="output"></pre>  
    <button id="prevPage" style="display:none;">上一页</button>  
    <button id="nextPage" style="display:none;">下一页</button>  

    <script>  
        let postsData = [];  
        let currentPage = 0;  
        const postsPerPage = 30;  
        
        document.getElementById('fetchForm').addEventListener('submit', async function(event) {  
            event.preventDefault();  

            const userId = document.getElementById('userId').value;  
            const forumId = document.getElementById('forumId').value;  
            const pageSize = document.getElementById('pageSize').value;  
            const output = document.getElementById('output');  
            output.textContent = 'Loading...';  

            try {  
                const response = await fetch(`https://choa.fun/api/v0/user/list_posts?marker=&pageSize=${pageSize}&forumId=${forumId}&userId=${userId}`);  
                const data = await response.json();  

                if (data.success) {  
                    postsData = data.data.posts;  
                    currentPage = 0; // 重置当前页到第一页  
                    displayPosts();  
                } else {  
                    output.textContent = '请求失败，请检查后重试！';  
                }  
            } catch (error) {  
                console.error(error);  
                output.textContent = '发生错误，请重试！';  
            }  
        });  

        function displayPosts() {  
            const output = document.getElementById('output');  
            output.innerHTML = '';  
            const start = currentPage * postsPerPage;  
            const end = start + postsPerPage;  
            const currentPosts = postsData.slice(start, end);  
            
            output.innerHTML += `<strong>成功爬取 ${postsData.length} 个帖子</strong><br><br>`;  
            currentPosts.forEach((post, index) => {  
                output.innerHTML += `<strong>${post.title}</strong> (ID: ${post.postId})<br>`;  
                output.innerHTML += `内容: ${post.content || '无内容'}<br>`;  
                output.innerHTML += `评论数: ${post.comments}<br>`;  

                // 下载帖子内容的按钮  
                output.innerHTML += `<button onclick="downloadPost(${start + index})">下载此帖子</button>`;  

                // 下载图片的按钮（假设图片在 post.images 数组中）  
                if (post.images && post.images.length > 0) {  
                    post.images.forEach((image, imgIndex) => {  
                        const fullImageUrl = image.startsWith('http') ? image : `https://i.chao-fan.com/${image}`;  
                        output.innerHTML += `<a href="${fullImageUrl}" target="_blank"><button>查看图片 ${imgIndex + 1}</button></a>`;  
                    });  
                }  
                output.innerHTML += '<br><br>';  
            });  

            // 更新“上一页”和“下一页”按钮的可见性  
            document.getElementById('prevPage').style.display = currentPage > 0 ? 'inline' : 'none';  
            document.getElementById('nextPage').style.display = end < postsData.length ? 'inline' : 'none';  
        }  

        document.getElementById('prevPage').addEventListener('click', function() {  
            if (currentPage > 0) {  
                currentPage--;  
                displayPosts();  
            }  
        });  

        document.getElementById('nextPage').addEventListener('click', function() {  
            if ((currentPage + 1) * postsPerPage < postsData.length) {  
                currentPage++;  
                displayPosts();  
            }  
        });  

        function downloadPost(index) {  
            const post = postsData[index];  
            const blob = new Blob([JSON.stringify(post, null, 4)], { type: 'application/json' });  
            const url = URL.createObjectURL(blob);  
            const a = document.createElement('a');  
            a.href = url;  
            a.download = `post_${post.postId}.json`;  
            document.body.appendChild(a);  
            a.click();  
            document.body.removeChild(a);  
            URL.revokeObjectURL(url); // 释放内存  
        }  
    </script>  
</body>  
</html>
